import { NextRequest, NextResponse } from 'next/server';

/**
 * ìµœì í™”ëœ êµ¬ì¡°í™”ëœ ì´ë©”ì¼ ë‚´ìš© ìƒì„± (ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê³ ë ¤)
 */
function generateOptimizedEmailContent(question: string): string {
  const now = new Date();
  const ticketId = `FAQ-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getTime().toString().slice(-6)}`;
  const timestamp = now.toLocaleString('ko-KR', {
    year: 'numeric',
    month: 'long', 
    day: 'numeric',
    weekday: 'long',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });

  // ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
  const category = categorizeQuestion(question);
  const priority = determinePriority(question);

  return `========================================
Meta FAQ ì±—ë´‡ ë¬¸ì˜ì‚¬í•­ ì ‘ìˆ˜
========================================

ì•ˆë…•í•˜ì„¸ìš”, ë‹´ë‹¹íŒ€ë‹˜

Meta FAQ ì±—ë´‡ ì‹œìŠ¤í…œì„ í†µí•´ ìƒˆë¡œìš´ ë¬¸ì˜ì‚¬í•­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.

[ì ‘ìˆ˜ ì •ë³´]
- í‹°ì¼“ ë²ˆí˜¸: ${ticketId}
- ì ‘ìˆ˜ ì‹œê°„: ${timestamp}
- ë¬¸ì˜ ì¹´í…Œê³ ë¦¬: ${category.name}
- ìš°ì„ ìˆœìœ„: ${priority.level} (${priority.description})
- ì ‘ìˆ˜ ê²½ë¡œ: Meta FAQ AI ì±—ë´‡

[ë¬¸ì˜ ë‚´ìš©]
${formatQuestionContent(question)}

[ì‹œìŠ¤í…œ ì •ë³´]
- ê²€ìƒ‰ ê²°ê³¼: ê´€ë ¨ ë‚´ë¶€ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
- ì±—ë´‡ ì‹ ë¢°ë„: ì •ë³´ ë¶€ì¡±ìœ¼ë¡œ ë‹µë³€ ë¶ˆê°€
- ì¶”ì²œ ì¡°ì¹˜: ${category.recommendedAction}

[ì²˜ë¦¬ ìš”ì²­ì‚¬í•­]
ìš”ì²­ì‚¬í•­:
â€¢ ìœ„ ë¬¸ì˜ì‚¬í•­ì— ëŒ€í•œ ì •í™•í•œ ë‹µë³€ ì œê³µ
â€¢ ê°€ëŠ¥í•œ ê²½ìš° ê´€ë ¨ ìë£Œë‚˜ ê°€ì´ë“œë¼ì¸ ì²¨ë¶€
â€¢ í–¥í›„ ìœ ì‚¬ ì§ˆë¬¸ ëŒ€ì‘ì„ ìœ„í•œ FAQ ì—…ë°ì´íŠ¸ ê²€í† 

ì°¸ê³ ì‚¬í•­:
â€¢ ì‚¬ìš©ìëŠ” AI ì±—ë´‡ì„ í†µí•´ ë‹µë³€ì„ ì°¾ìœ¼ë ¤ í–ˆìœ¼ë‚˜ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤
â€¢ ì´ ë¬¸ì˜ëŠ” ë‚´ë¶€ ë¬¸ì„œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒì„ ì‹œì‚¬í•©ë‹ˆë‹¤
â€¢ ë‹µë³€ í›„ FAQ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤

ì˜ˆìƒ ì‘ë‹µ ì‹œê°„: ${priority.responseTime}

[ì—°ë½ì²˜ ì •ë³´]
- íšŒì‹  ì£¼ì†Œ: fb@nasmedia.co.kr
- ì‹œìŠ¤í…œ ê´€ë¦¬: Meta FAQ ì±—ë´‡ ê´€ë¦¬íŒ€
- ê¸´ê¸‰ ì—°ë½: ì‹œìŠ¤í…œ ì¥ì•  ì‹œ ê´€ë¦¬íŒ€ ì—°ë½ ë°”ëë‹ˆë‹¤

========================================

ì´ ë©”ì¼ì€ Meta FAQ ì±—ë´‡ ì‹œìŠ¤í…œì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
í‹°ì¼“ ë²ˆí˜¸: ${ticketId}
ìƒì„± ì‹œê°„: ${new Date().toISOString()}

ê°ì‚¬í•©ë‹ˆë‹¤.
Meta FAQ ì±—ë´‡ ì‹œìŠ¤í…œ`;
}

/**
 * ê°„ì†Œí™”ëœ ì´ë©”ì¼ ë‚´ìš© ìƒì„± (ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•´)
 */
function generateSimplifiedEmailContent(question: string): string {
  const now = new Date();
  const timestamp = now.toLocaleString('ko-KR');
  
  return `ì•ˆë…•í•˜ì„¸ìš”,

Meta FAQ ì±—ë´‡ì„ í†µí•´ ë¬¸ì˜ì‚¬í•­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¬¸ì˜ ì‹œê°„: ${timestamp}
ë¬¸ì˜ ë‚´ìš©: ${question}

ìœ„ ë¬¸ì˜ì‚¬í•­ì— ëŒ€í•´ ë‹µë³€ì„ ì œê³µí•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.
Meta FAQ ì±—ë´‡ ì‹œìŠ¤í…œ`;
}

/**
 * êµ¬ì¡°í™”ëœ ì´ë©”ì¼ ë‚´ìš© ìƒì„± (ì°¸ê³ ìš©)
 */
function generateStructuredEmailContent(question: string): string {
  const now = new Date();
  const ticketId = `FAQ-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getTime().toString().slice(-6)}`;
  const timestamp = now.toLocaleString('ko-KR', {
    year: 'numeric',
    month: 'long', 
    day: 'numeric',
    weekday: 'long',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });

  // ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
  const category = categorizeQuestion(question);
  const priority = determinePriority(question);

  return `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           Meta FAQ ì±—ë´‡ ë¬¸ì˜ì‚¬í•­ ì ‘ìˆ˜                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì•ˆë…•í•˜ì„¸ìš”, ë‹´ë‹¹íŒ€ë‹˜

Meta FAQ ì±—ë´‡ ì‹œìŠ¤í…œì„ í†µí•´ ìƒˆë¡œìš´ ë¬¸ì˜ì‚¬í•­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ğŸ“‹ ì ‘ìˆ˜ ì •ë³´                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ« í‹°ì¼“ ë²ˆí˜¸      : ${ticketId}
ğŸ“… ì ‘ìˆ˜ ì‹œê°„      : ${timestamp}
ğŸ“‚ ë¬¸ì˜ ì¹´í…Œê³ ë¦¬   : ${category.name}
âš¡ ìš°ì„ ìˆœìœ„       : ${priority.level} (${priority.description})
ğŸ¤– ì ‘ìˆ˜ ê²½ë¡œ      : Meta FAQ AI ì±—ë´‡

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ğŸ’¬ ë¬¸ì˜ ë‚´ìš©                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

${formatQuestionContent(question)}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” ê²€ìƒ‰ ê²°ê³¼      : ê´€ë ¨ ë‚´ë¶€ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
ğŸ“ˆ ì±—ë´‡ ì‹ ë¢°ë„     : ì •ë³´ ë¶€ì¡±ìœ¼ë¡œ ë‹µë³€ ë¶ˆê°€
ğŸ¯ ì¶”ì²œ ì¡°ì¹˜      : ${category.recommendedAction}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ğŸ“ ì²˜ë¦¬ ìš”ì²­ì‚¬í•­                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… ìš”ì²­ì‚¬í•­:
   â€¢ ìœ„ ë¬¸ì˜ì‚¬í•­ì— ëŒ€í•œ ì •í™•í•œ ë‹µë³€ ì œê³µ
   â€¢ ê°€ëŠ¥í•œ ê²½ìš° ê´€ë ¨ ìë£Œë‚˜ ê°€ì´ë“œë¼ì¸ ì²¨ë¶€
   â€¢ í–¥í›„ ìœ ì‚¬ ì§ˆë¬¸ ëŒ€ì‘ì„ ìœ„í•œ FAQ ì—…ë°ì´íŠ¸ ê²€í† 

ğŸ“‹ ì°¸ê³ ì‚¬í•­:
   â€¢ ì‚¬ìš©ìëŠ” AI ì±—ë´‡ì„ í†µí•´ ë‹µë³€ì„ ì°¾ìœ¼ë ¤ í–ˆìœ¼ë‚˜ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤
   â€¢ ì´ ë¬¸ì˜ëŠ” ë‚´ë¶€ ë¬¸ì„œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒì„ ì‹œì‚¬í•©ë‹ˆë‹¤
   â€¢ ë‹µë³€ í›„ FAQ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤

â° ì˜ˆìƒ ì‘ë‹µ ì‹œê°„: ${priority.responseTime}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ğŸ“ ì—°ë½ì²˜ ì •ë³´                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“§ íšŒì‹  ì£¼ì†Œ      : fb@nasmedia.co.kr
ğŸ¤– ì‹œìŠ¤í…œ ê´€ë¦¬     : Meta FAQ ì±—ë´‡ ê´€ë¦¬íŒ€
ğŸ“± ê¸´ê¸‰ ì—°ë½      : ì‹œìŠ¤í…œ ì¥ì•  ì‹œ ê´€ë¦¬íŒ€ ì—°ë½ ë°”ëë‹ˆë‹¤

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì´ ë©”ì¼ì€ Meta FAQ ì±—ë´‡ ì‹œìŠ¤í…œì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
í‹°ì¼“ ë²ˆí˜¸: ${ticketId}
ìƒì„± ì‹œê°„: ${new Date().toISOString()}

ê°ì‚¬í•©ë‹ˆë‹¤.
Meta FAQ ì±—ë´‡ ì‹œìŠ¤í…œ ğŸ¤–
  `.trim();
}

/**
 * ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
 */
function categorizeQuestion(question: string): { name: string; recommendedAction: string } {
  const lowerQuestion = question.toLowerCase();
  
  if (lowerQuestion.includes('ì •ì±…') || lowerQuestion.includes('ê·œì •') || lowerQuestion.includes('ê°€ì´ë“œë¼ì¸')) {
    return {
      name: 'ğŸ“‹ ì •ì±… ë° ê°€ì´ë“œë¼ì¸',
      recommendedAction: 'ìµœì‹  ì •ì±… ë¬¸ì„œ í™•ì¸ í›„ ìƒì„¸ ë‹µë³€ ì œê³µ'
    };
  }
  
  if (lowerQuestion.includes('ê´‘ê³ ') || lowerQuestion.includes('ìº í˜ì¸') || lowerQuestion.includes('ë§ˆì¼€íŒ…')) {
    return {
      name: 'ğŸ“¢ ê´‘ê³  ë° ë§ˆì¼€íŒ…',
      recommendedAction: 'ê´‘ê³  ìš´ì˜íŒ€ê³¼ í˜‘ì˜í•˜ì—¬ ì „ë¬¸ì ì¸ ë‹µë³€ ì œê³µ'
    };
  }
  
  if (lowerQuestion.includes('ê³„ì •') || lowerQuestion.includes('ë¡œê·¸ì¸') || lowerQuestion.includes('ê¶Œí•œ')) {
    return {
      name: 'ğŸ‘¤ ê³„ì • ë° ê¶Œí•œ',
      recommendedAction: 'ê³„ì • ê´€ë¦¬íŒ€ ê²€í†  í›„ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­ í¬í•¨í•˜ì—¬ ë‹µë³€'
    };
  }
  
  if (lowerQuestion.includes('ê¸°ìˆ ') || lowerQuestion.includes('ì˜¤ë¥˜') || lowerQuestion.includes('ë²„ê·¸')) {
    return {
      name: 'ğŸ”§ ê¸°ìˆ ì  ë¬¸ì œ',
      recommendedAction: 'ê¸°ìˆ íŒ€ ì—ìŠ¤ì»¬ë ˆì´ì…˜ í›„ í•´ê²°ë°©ì•ˆ ì œì‹œ'
    };
  }
  
  if (lowerQuestion.includes('íšŒì‚¬') || lowerQuestion.includes('ì¡°ì§') || lowerQuestion.includes('ì—…ë¬´')) {
    return {
      name: 'ğŸ¢ íšŒì‚¬ ë° ì¡°ì§',
      recommendedAction: 'ì¸ì‚¬íŒ€ ë˜ëŠ” ê´€ë ¨ ë¶€ì„œ í™•ì¸ í›„ ê³µì‹ ë‹µë³€ ì œê³µ'
    };
  }
  
  return {
    name: 'â“ ì¼ë°˜ ë¬¸ì˜',
    recommendedAction: 'ê´€ë ¨ ë¶€ì„œ í™•ì¸ í›„ ì ì ˆí•œ ë‹µë³€ ì œê³µ'
  };
}

/**
 * ìš°ì„ ìˆœìœ„ ê²°ì •
 */
function determinePriority(question: string): { level: string; description: string; responseTime: string } {
  const lowerQuestion = question.toLowerCase();
  
  if (lowerQuestion.includes('ê¸´ê¸‰') || lowerQuestion.includes('ì˜¤ë¥˜') || lowerQuestion.includes('ë¬¸ì œ')) {
    return {
      level: 'ğŸ”´ ë†’ìŒ',
      description: 'ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš”',
      responseTime: '4ì‹œê°„ ì´ë‚´'
    };
  }
  
  if (lowerQuestion.includes('ì •ì±…') || lowerQuestion.includes('ê°€ì´ë“œë¼ì¸')) {
    return {
      level: 'ğŸŸ¡ ë³´í†µ',
      description: 'ì •ì±… ê´€ë ¨ ì¤‘ìš” ë¬¸ì˜',
      responseTime: '1ì˜ì—…ì¼ ì´ë‚´'
    };
  }
  
  return {
    level: 'ğŸŸ¢ ì¼ë°˜',
    description: 'ì¼ë°˜ì ì¸ ë¬¸ì˜ì‚¬í•­',
    responseTime: '2-3ì˜ì—…ì¼ ì´ë‚´'
  };
}

/**
 * ì§ˆë¬¸ ë‚´ìš© í¬ë§·íŒ…
 */
function formatQuestionContent(question: string): string {
  // ì§ˆë¬¸ì´ ë„ˆë¬´ ê¸¸ë©´ ì¤„ë°”ê¿ˆ ì¶”ê°€
  if (question.length > 100) {
    return question.match(/.{1,80}(\s|$)/g)?.join('\n   ') || question;
  }
  return `   ${question}`;
}

export async function POST(request: NextRequest) {
  try {
    const { question } = await request.json();

    // ì…ë ¥ ê²€ì¦
    if (!question) {
      return NextResponse.json(
        { error: 'ì§ˆë¬¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // ì´ë©”ì¼ ë‚´ìš© êµ¬ì„± (êµ¬ì¡°í™”ëœ ë²„ì „ - ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê³ ë ¤)
    const emailSubject = `[Meta FAQ ì±—ë´‡] ë¬¸ì˜ì‚¬í•­: ${question.substring(0, 50)}...`;
    const emailBody = generateOptimizedEmailContent(question);

    // ì´ë©”ì¼ ë§í¬ ìƒì„± (mailto:) - URL ê¸¸ì´ ì œí•œ ê³ ë ¤
    const emailLink = `mailto:fb@nasmedia.co.kr?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;

    console.log(`ğŸ“§ ì´ë©”ì¼ ì—°ë½ì²˜ ìš”ì²­: ${question.substring(0, 100)}...`);
    console.log(`ğŸ“§ ë©”ì¼ ë§í¬ ê¸¸ì´: ${emailLink.length}ì`);
    console.log(`ğŸ“§ ë©”ì¼ ì œëª©: ${emailSubject}`);
    console.log(`ğŸ“§ ë©”ì¼ ë‚´ìš© ê¸¸ì´: ${emailBody.length}ì`);
    
    // URL ê¸¸ì´ê°€ ë„ˆë¬´ ê¸¸ë©´ ê°„ì†Œí™”ëœ ë²„ì „ ì‚¬ìš©
    if (emailLink.length > 2000) {
      console.log('âš ï¸ URLì´ ë„ˆë¬´ ê¸¸ì–´ì„œ ê°„ì†Œí™”ëœ ë²„ì „ ì‚¬ìš©');
      const simplifiedBody = generateSimplifiedEmailContent(question);
      const simplifiedLink = `mailto:fb@nasmedia.co.kr?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(simplifiedBody)}`;
      console.log(`ğŸ“§ ê°„ì†Œí™”ëœ ë§í¬ ê¸¸ì´: ${simplifiedLink.length}ì`);
      
      return NextResponse.json({
        success: true,
        emailLink: simplifiedLink,
        message: 'ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
        simplified: true
      });
    }

    return NextResponse.json({
      success: true,
      emailLink,
      message: 'ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('âŒ ì´ë©”ì¼ ì—°ë½ì²˜ ìƒì„± ì‹¤íŒ¨:', error);
    return NextResponse.json(
      { error: 'ì´ë©”ì¼ ì—°ë½ì²˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}